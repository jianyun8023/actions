# OpenMemory - Docker Compose 配置
# 基于官方仓库: https://github.com/mem0ai/mem0/tree/main/openmemory
# 使用自建 GHCR 镜像

version: '3.9'

services:
  # Qdrant 向量数据库
  qdrant:
    image: qdrant/qdrant:latest
    container_name: openmemory-qdrant
    ports:
      - "6333:6333"    # REST API
      - "6334:6334"    # gRPC
    volumes:
      - qdrant_storage:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    restart: unless-stopped
    networks:
      - openmemory-network

  # OpenMemory API 服务
  openmemory-api:
    image: ghcr.io/jianyun8023/openmemory-api:latest
    container_name: openmemory-api
    depends_on:
      - qdrant
    # 端口映射（可选）
    # 使用代理模式时，API 不需要对外暴露端口
    # 如需直接访问 API（如调试），可取消注释下面一行
    ports:
      - "8765:8765"
    environment:
      # 用户配置
      - USER=admin                          # 用户 ID（与 UI 保持一致）
      # OpenAI 配置
      - OPENAI_API_KEY=${OPENAI_API_KEY}    # 必需：OpenAI API Key
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}  # 可选：OpenAI API Base URL
      # 数据库配置
      - DATABASE_URL=sqlite:////var/lib/openmemory/openmemory.db
      # Qdrant 配置
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
    volumes:
      - api_data:/var/lib/openmemory        # 持久化 SQLite 数据库
      # 可选：挂载自定义配置文件（如使用硅基流动/Ollama等）
      # - ./config.json:/usr/src/openmemory/config.json:ro
    command: uvicorn main:app --host 0.0.0.0 --port 8765 --workers 4
    restart: unless-stopped
    networks:
      - openmemory-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8765/').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # OpenMemory UI 服务
  openmemory-ui:
    image: ghcr.io/jianyun8023/openmemory-ui:latest
    container_name: openmemory-ui
    depends_on:
      - openmemory-api
    ports:
      - "3000:3000"
    environment:
      # ============ 代理模式配置（推荐）============
      # 浏览器端 API 地址：使用相对路径，由 Next.js 代理转发到后端
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-/api}
      # 服务端内部 API 地址：Docker 网络内部地址
      - INTERNAL_API_URL=${INTERNAL_API_URL:-http://openmemory-api:8765}
      
      # ============ 直连模式配置（传统方式）============
      # 如果希望浏览器直接访问后端 API（不推荐），可以设置：
      # - NEXT_PUBLIC_API_URL=http://localhost:8765
      # 并取消注释 openmemory-api 的端口映射
      
      # 用户 ID（与 API 保持一致）
      - NEXT_PUBLIC_USER_ID=admin
    restart: unless-stopped
    networks:
      - openmemory-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/', (res) => process.exit(res.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  qdrant_storage:
    driver: local
  api_data:
    driver: local

networks:
  openmemory-network:
    driver: bridge

